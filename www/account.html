<html>
<link rel="stylesheet" type="text/css" href="styles/style.css">
<script type="text/javascript" src="scripts/jquery.3.4.1.js"></script>
<script type="text/javascript" src="scripts/xsrf.js"></script>
<script type="text/javascript" src="scripts/utils.js"></script>
<script type="text/javascript" src="scripts/notification.js"></script>

<head>
</head>

<body>
    <div class=Content>
        <h1>Account</h1>
        Hallo hanno!
        <button class=pull-right onclick="logOut()">Logout</button>
        <button id=Subscribe class="pull-right mr10" onclick="subscribe()">Subscribe to notifications</button>
        <h2>Targets</h2>
        <div id=TargetError class="ErrorMsg NoDisplay mt10"></div>
        <table id=Targets>
        </table>

        <h2>Clients</h2>
        <table id=Clients>
        </table>
    </div>

    <script>
        $(() => setTimeout(() => {
            bindTargetList();
            bindClientList();
            
            // Hide subscribe if already granted
            // if(Notification.permission == 'granted') 
                // $("#Subscribe").hide();
        }, 1));

        // Get the targets list for this user from the server
        var deleteAndEditBtn = '<td class=align-right>'
            + '<img onclick="inlineEdit($(this).parent().parent(), updateTarget, \'targetID\')" class="fa blue" src=img/edit.svg></img>'
            + '<img onclick="deleteTarget($(this).parent().parent())" class="fa ml5 red" src=img/trash-alt.svg></img>'
            + '</td>'
        function bindTargetList() {
            getList('target/list', '#Targets', 'targetID', [
                { name: "URL", field: "websiteUrl", editable: true },
                { name: "Selector", field: "selector", editable: true },
                { name: "Last Update", field: "lastUpdate", templater: toDate },
                { name: "", template: deleteAndEditBtn },
            ], updateTarget);
        }
        function bindClientList() {
            getList('notification/clients', '#Clients', 'P256dh', [
                { name: "Device", field: "device" },
                { name: "Browser", field: "browser" },
                { name: "Token", field: "auth" },
            ]);
        }


        function updateTarget(targetModel) {
            console.log(targetModel);
            $.ajax({
                method: "POST",
                url: "/target/update",
                data: targetModel,
                success: (result) => {
                    if (result) {
                        bindTargetList();
                        $("#TargetError").hide();
                    } else 
                        targetError("Kon target niet updaten.");
                },
                error: (err) => targetError("Kon target niet updaten.")
            });
        }

        function targetError(err) {
            $("#TargetError").html(err);
            $("#TargetError").show();
        }

        function deleteTarget(target) {
            var targetId = target.data("val");
            $.ajax({
                method: "GET",
                url: "/target/delete",
                data: { id: targetId },
                success: (result) => {
                    if (result) {
                        bindTargetList();
                        $("#TargetError").hide();
                    } else
                        targetError("Kon target niet verwijderen.");
                },
                error: (err) => targetError("Kon target niet verwijderen."),
            });
        }
    </script>
</body>

</html>